FROM lakhansamani/authorizer:2.0.0-rc.1

# v2 uses CLI arguments only. Railway injects env vars; shell form CMD expands them at runtime.
# Use $$ to prevent Docker build-time expansion.
CMD ["sh", "-c", "./authorizer" \
  --database-type="$${DATABASE_TYPE:-postgres}" \
  --database-url="$${DATABASE_URL}" \
  --client-id="$${CLIENT_ID}" \
  --client-secret="$${CLIENT_SECRET}" \
  --admin-secret="$${ADMIN_SECRET}" \
  --redis-url="$${REDIS_URL}" \
  --jwt-type="$${JWT_TYPE}" \
  --jwt-secret="$${JWT_SECRET}" \
  --jwt-private-key="$${JWT_PRIVATE_KEY}" \
  --jwt-public-key="$${JWT_PUBLIC_KEY}" \
  --jwt-role-claim="$${JWT_ROLE_CLAIM}" \
  --custom-access-token-script="$${CUSTOM_ACCESS_TOKEN_SCRIPT}" \
  --roles="$${ROLES}" \
  --default-roles="$${DEFAULT_ROLES}" \
  --protected-roles="$${PROTECTED_ROLES}" \
  --allowed-origins="$${ALLOWED_ORIGINS}" \
  --default-authorize-response-type="$${DEFAULT_AUTHORIZE_RESPONSE_TYPE}" \
  --default-authorize-response-mode="$${DEFAULT_AUTHORIZE_RESPONSE_MODE}" \
  --organization-name="$${ORGANIZATION_NAME}" \
  --organization-logo="$${ORGANIZATION_LOGO}" \
  --smtp-host="$${SMTP_HOST}" \
  --smtp-port="$${SMTP_PORT}" \
  --smtp-username="$${SMTP_USERNAME}" \
  --smtp-password="$${SMTP_PASSWORD}" \
  --smtp-sender-email="$${SENDER_EMAIL}" \
  --smtp-sender-name="$${SENDER_NAME}" \
  --reset-password-url="$${RESET_PASSWORD_URL}" \
  --env="$${ENV}" \
  --host="$${HOST:-0.0.0.0}" \
  --metrics-port="$${METRICS_PORT:-8081}" \
  --enable-login-page="$${ENABLE_LOGIN_PAGE:-true}" \
  --enable-playground="$${ENABLE_PLAYGROUND:-true}" \
  --disable-admin-header-auth="$${DISABLE_ADMIN_HEADER_AUTH:-true}" \
  --enable-graphql-introspection="$${ENABLE_GRAPHQL_INTROSPECTION:-true}" \
  --app-cookie-secure="$${APP_COOKIE_SECURE:-true}" \
  --admin-cookie-secure="$${ADMIN_COOKIE_SECURE:-true}" \
  --database-name="$${DATABASE_NAME}" \
  --database-username="$${DATABASE_USERNAME}" \
  --database-password="$${DATABASE_PASSWORD}" \
  --database-host="$${DATABASE_HOST}" \
  --database-port="$${DATABASE_PORT}" \
  --database-cert="$${DATABASE_CERT}" \
  --database-ca-cert="$${DATABASE_CA_CERT}" \
  --database-cert-key="$${DATABASE_CERT_KEY}" \
  --couchbase-bucket="$${COUCHBASE_BUCKET}" \
  --couchbase-scope="$${COUCHBASE_SCOPE}" \
  --couchbase-ram-quota="$${COUCHBASE_RAM_QUOTA}" \
  --aws-region="$${AWS_REGION}" \
  --aws-access-key-id="$${AWS_ACCESS_KEY_ID}" \
  --aws-secret-access-key="$${AWS_SECRET_ACCESS_KEY}" \
  --smtp-local-name="$${SMTP_LOCAL_NAME}" \
  --skip-tls-verification="$${SKIP_TLS_VERIFICATION:-false}" \
  --enable-strong-password="$${ENABLE_STRONG_PASSWORD:-true}" \
  --enable-totp-login="$${ENABLE_TOTP_LOGIN:-false}" \
  --enable-basic-authentication="$${ENABLE_BASIC_AUTHENTICATION:-true}" \
  --enable-email-verification="$${ENABLE_EMAIL_VERIFICATION:-false}" \
  --enable-mobile-basic-authentication="$${ENABLE_MOBILE_BASIC_AUTHENTICATION:-true}" \
  --enable-phone-verification="$${ENABLE_PHONE_VERIFICATION:-false}" \
  --enable-magic-link-login="$${ENABLE_MAGIC_LINK_LOGIN:-false}" \
  --enforce-mfa="$${ENFORCE_MFA:-true}" \
  --enable-mfa="$${ENABLE_MFA:-false}" \
  --enable-email-otp="$${ENABLE_EMAIL_OTP:-false}" \
  --enable-sms-otp="$${ENABLE_SMS_OTP:-false}" \
  --enable-signup="$${ENABLE_SIGNUP:-true}" \
  --twilio-account-sid="$${TWILIO_ACCOUNT_SID}" \
  --twilio-api-key="$${TWILIO_API_KEY}" \
  --twilio-api-secret="$${TWILIO_API_SECRET}" \
  --twilio-sender="$${TWILIO_SENDER}" \
  --google-client-id="$${GOOGLE_CLIENT_ID}" \
  --google-client-secret="$${GOOGLE_CLIENT_SECRET}" \
  --google-scopes="$${GOOGLE_SCOPES}" \
  --github-client-id="$${GITHUB_CLIENT_ID}" \
  --github-client-secret="$${GITHUB_CLIENT_SECRET}" \
  --github-scopes="$${GITHUB_SCOPES}" \
  --facebook-client-id="$${FACEBOOK_CLIENT_ID}" \
  --facebook-client-secret="$${FACEBOOK_CLIENT_SECRET}" \
  --facebook-scopes="$${FACEBOOK_SCOPES}" \
  --microsoft-client-id="$${MICROSOFT_CLIENT_ID}" \
  --microsoft-client-secret="$${MICROSOFT_CLIENT_SECRET}" \
  --microsoft-tenant-id="$${MICROSOFT_TENANT_ID}" \
  --microsoft-scopes="$${MICROSOFT_SCOPES}" \
  --apple-client-id="$${APPLE_CLIENT_ID}" \
  --apple-client-secret="$${APPLE_CLIENT_SECRET}" \
  --apple-scopes="$${APPLE_SCOPES}" \
  --discord-client-id="$${DISCORD_CLIENT_ID}" \
  --discord-client-secret="$${DISCORD_CLIENT_SECRET}" \
  --discord-scopes="$${DISCORD_SCOPES}" \
  --linkedin-client-id="$${LINKEDIN_CLIENT_ID}" \
  --linkedin-client-secret="$${LINKEDIN_CLIENT_SECRET}" \
  --linkedin-scopes="$${LINKEDIN_SCOPES}" \
  --twitch-client-id="$${TWITCH_CLIENT_ID}" \
  --twitch-client-secret="$${TWITCH_CLIENT_SECRET}" \
  --twitch-scopes="$${TWITCH_SCOPES}" \
  --twitter-client-id="$${TWITTER_CLIENT_ID}" \
  --twitter-client-secret="$${TWITTER_CLIENT_SECRET}" \
  --twitter-scopes="$${TWITTER_SCOPES}" \
  --roblox-client-id="$${ROBLOX_CLIENT_ID}" \
  --roblox-client-secret="$${ROBLOX_CLIENT_SECRET}" \
  --roblox-scopes="$${ROBLOX_SCOPES}" \
  --log-level="$${LOG_LEVEL:-info}" \
  --http-port="$${PORT:-8080}"]